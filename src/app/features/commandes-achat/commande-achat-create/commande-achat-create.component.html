<div class="commande-create-container">
  <p-card>
    <div class="header-section">
      <h2>Nouvelle Commande d'Achat</h2>
      <button
        pButton
        icon="pi pi-arrow-left"
        label="Retour"
        class="p-button-secondary"
        (click)="annuler()"
      ></button>
    </div>

    <form [formGroup]="commandeForm" (ngSubmit)="onSubmit()">
      <!-- Sélection demande d'approvisionnement -->
      <div class="section demande-appro-section">
        <h3>Demande d'Approvisionnement</h3>
        <div class="field">
          <label for="demande_appro">Sélectionner une demande d'approvisionnement (optionnel)</label>
          <p-dropdown
            id="demande_appro"
            [options]="demandesAppro"
            [(ngModel)]="selectedDemandeId"
            [ngModelOptions]="{standalone: true}"
            optionLabel="label"
            optionValue="value"
            placeholder="Choisir une demande d'approvisionnement..."
            [filter]="true"
            [showClear]="true"
            (onChange)="onDemandeApproChange($event)"
            [style]="{'width':'100%'}"
          >
          </p-dropdown>
          <small class="hint">
            <i class="pi pi-info-circle"></i>
            Sélectionnez une demande pour charger automatiquement les produits demandés
          </small>
        </div>
      </div>

      <!-- Informations générales -->
      <div class="section">
        <h3>Informations Générales</h3>
        <div class="field-grid">
          <div class="field">
            <label for="fournisseur_id">Fournisseur *</label>
            <p-dropdown 
              id="fournisseur_id"
              formControlName="fournisseur_id"
              [options]="fournisseurs"
              optionLabel="nom"
              optionValue="id"
              placeholder="Sélectionner un fournisseur"
              [filter]="true"
              filterBy="nom"
              [class.ng-invalid]="commandeForm.get('fournisseur_id')?.invalid && commandeForm.get('fournisseur_id')?.touched"
            >
              <ng-template let-fournisseur pTemplate="item">
                <div>
                  <strong>{{ fournisseur.nom }}</strong>
                  <br>
                  <small>{{ fournisseur.telephone }}</small>
                </div>
              </ng-template>
            </p-dropdown>
            <small class="p-error" *ngIf="commandeForm.get('fournisseur_id')?.invalid && commandeForm.get('fournisseur_id')?.touched">
              Le fournisseur est requis
            </small>
          </div>

          <div class="field">
            <label for="date_commande">Date de Commande *</label>
            <p-calendar 
              id="date_commande"
              formControlName="date_commande"
              [showIcon]="true"
              dateFormat="dd/mm/yy"
              [class.ng-invalid]="commandeForm.get('date_commande')?.invalid && commandeForm.get('date_commande')?.touched"
            ></p-calendar>
          </div>

          <div class="field">
            <label for="date_livraison_prevue">Date de Livraison Prévue</label>
            <p-calendar 
              id="date_livraison_prevue"
              formControlName="date_livraison_prevue"
              [showIcon]="true"
              dateFormat="dd/mm/yy"
            ></p-calendar>
          </div>
        </div>
      </div>

      <!-- Produits -->
      <div class="section">
        <div class="section-header">
          <h3>Produits</h3>
          <button 
            pButton 
            type="button"
            icon="pi pi-plus" 
            label="Ajouter une ligne"
            class="p-button-sm"
            (click)="ajouterLigne()"
          ></button>
        </div>

        <div class="produits-table">
          <div class="table-header">
            <div class="col-produit">Produit</div>
            <div class="col-quantite">Quantité</div>
            <div class="col-prix">Prix Unitaire</div>
            <div class="col-total">Sous-total</div>
            <div class="col-action">Action</div>
          </div>

          <div class="table-body" formArrayName="produits">
            <div
              class="table-row"
              *ngFor="let ligne of produitsArray.controls; let i = index"
              [formGroupName]="i"
            >
              <div class="col-produit">
                <p-dropdown
                  formControlName="produit_id"
                  [options]="produits"
                  optionLabel="nom"
                  optionValue="id"
                  placeholder="Sélectionner un produit"
                  [filter]="true"
                  filterBy="nom,code"
                  [class.ng-invalid]="ligne.get('produit_id')?.invalid && ligne.get('produit_id')?.touched"
                >
                  <ng-template let-produit pTemplate="item">
                    <div>
                      <strong>{{ produit.nom }}</strong>
                      <br>
                      <small>{{ produit.code }} - {{ formatCurrency(produit.prix_achat) }}</small>
                    </div>
                  </ng-template>
                </p-dropdown>
              </div>

              <div class="col-quantite">
                <p-inputNumber
                  formControlName="quantite"
                  [showButtons]="true"
                  [min]="1"
                  [class.ng-invalid]="ligne.get('quantite')?.invalid && ligne.get('quantite')?.touched"
                ></p-inputNumber>
              </div>

              <div class="col-prix">
                <p-inputNumber
                  formControlName="prix_unitaire"
                  mode="decimal"
                  [minFractionDigits]="0"
                  [min]="0"
                  [class.ng-invalid]="ligne.get('prix_unitaire')?.invalid && ligne.get('prix_unitaire')?.touched"
                ></p-inputNumber>
              </div>

              <div class="col-total">
                <strong>{{ formatCurrency(calculerSousTotal(i)) }}</strong>
              </div>

              <div class="col-action">
                <button
                  pButton
                  type="button"
                  icon="pi pi-trash"
                  class="p-button-danger p-button-text"
                  (click)="supprimerLigne(i)"
                  [disabled]="produitsArray.length === 1"
                ></button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Total -->
      <div class="totaux-section">
        <div class="totaux-grid">
          <div class="totaux-row total">
            <span class="label">Montant Total:</span>
            <span class="value">{{ formatCurrency(montantTotal) }}</span>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="form-actions">
        <button 
          pButton 
          type="button"
          label="Annuler"
          icon="pi pi-times"
          class="p-button-secondary"
          (click)="annuler()"
        ></button>
        <button 
          pButton 
          type="submit"
          label="Créer la commande"
          icon="pi pi-check"
          [loading]="loading"
          [disabled]="commandeForm.invalid || loading"
          class="p-button-success"
        ></button>
      </div>
    </form>
  </p-card>
</div>

